---
output: 
    html_document:
        code_folding: hide
        df_print: tibble
        highlight: default
        theme: paper
        toc: true
        toc_depth: 5
        toc_float: true
        css: src/style/style.css

always_allow_html: yes
---
```{r, echo=FALSE, eval=TRUE, warning=FALSE}
chnkPrefix <- "dm."
VersionPdfExt <- VersionPdfExt <- paste0(".",chnkPrefix,"V", gsub("-", "", Sys.Date()), ".pdf")

```

```{r setup, include=FALSE}

# R used: module purge;source /camp/stp/babs/working/software/modulepath_new_software_tree_2018-08-13;module load pandoc/2.2.3.2-foss-2016b;ml R/4.0.3-foss-2020a



knitr::opts_chunk$set(
    tidy = F,
    tidy.opts = list(width.cutoff = 120),
    message = FALSE,
    warning = FALSE
)


if (!requireNamespace("remotes")){
  install.packages("remotes")
}


if (!requireNamespace("renv")){
  remotes::install_github("rstudio/renv")
}

if(!requireNamespace("destiny")){
    renv::install("bioc::destiny")
}

if(!requireNamespace("biologicToolsSC")){
    renv::install("decusInLabore/biologicToolsSC")
}



if (!file.exists("renv.lock")){
    renv::init()
    
} else {
    renv::restore(prompt = FALSE)
}

## If data analysis mode is used, no renv is used in order to prevent 
## interference with bespoke packages and environments
## In the data analysis mode is false, we expect the monocle3 outputs to be pre-generated.
```


```{r, echo=T, eval=TRUE, warning=FALSE, results=FALSE}

library(dplyr)

## Load biologic and Seurat object
source("load.biologic.robj.R")

## Reset paths to local environment
Obio <- Obio %>% 
    biologicSeqTools2::setMountingPoint()  %>% 
    biologicSeqTools2::setAnalysisPaths() %>% 
    biologicSeqTools2::setCrickGenomeAndGeneNameTable() %>% 
    biologicSeqTools2::createAnalysisFolders() %>% 
    biologicSeqTools2::setDataBaseParameters()
## Load Seurat object
SeuratFN <- paste0(Obio@parameterList$localWorkDir,list.files(Obio@parameterList$localWorkDir)[grep(".Seurat.Robj", list.files(Obio@parameterList$localWorkDir))])
if (file.exists(SeuratFN)){
    load(SeuratFN)
    print(paste0("Obio object ", Obio@parameterList$localWorkDir,SeuratFN, " exists and is loaded."))
    
} else {
    exit()
}
figureCount <- 1

## Select data for diffusion map pseudotime

ptBranches <- c("Pseudotime_MC_branch1", "Pseudotime_MC_branch2", "Pseudotime_MC_branch2")
dmBranches <- c("Pseudotime_DM_branch1", "Pseudotime_DM_branch2" , "Pseudotime_DM_branch2sub")
branches <- c("Branch1", "Branch2", "Branch2sub")
invertPTvec <- c(FALSE, TRUE, TRUE)

filterList <- list(
    "Branch1" = c(
        'GTCACTCGTTTGGCTA_2',
        'AAAGGGCCAATGGCAG_3',
        'TTGATGGCAGAAGCGT_3',
        'GTTACAGGTTGGTAGG_1',
        'ACTGTGAGTCGTTTCC_1',
        'CATCAAGTCCAAGAGG_1',
        'TCAGTTTAGTTGAATG_1',
        'GGGTATTAGGTAGCCA_1',
        'TACAGGTGTTGCAAGG_1',
        'GACAGCCTCGGTAGGA_1'
    )
)

plotList <- list()
chnkVec <- as.vector(NULL, mode = "character")



for (i in 1:length(branches)){
        if (branches[i] == "Branch2sub"){
            cellSel <- OsC@meta.data[OsC@meta.data[,ptBranches[i]] != 0 & !(OsC@meta.data$clusterName %in% c("Tuft", "Paneth")), "cellID"]
        } else {
            cellSel <- OsC@meta.data[OsC@meta.data[,ptBranches[i]] != 0, "cellID"]
        }
        
        
        OsC_dMap <- OsC[,colnames(OsC) %in% cellSel]
        
        ## this case only
        
        
        invertPT <- invertPTvec[i]
        
        
        
        
        
        #library(Seurat)
        #library(destiny)
        
        dfPCA <- OsC_dMap@meta.data
        dfPCA <- dfPCA[,grep("PC_", names(dfPCA))]
        
        ## cells to filter
        
        if (exists("filterList") & length(grep(branches[i], names(filterList))) > 0 ){
            cellsToFilter <- filterList[[branches[i]]]
        
            dfPCA <- dfPCA[!(row.names(dfPCA) %in% cellsToFilter),]
        }
        
        
        dmPCA <- destiny::DiffusionMap(
            dfPCA
        )
        
        
        
        
        #dpt <- DPT(dm, tips = 268)
        #dpt <- DPT(dm)
        dpt <- destiny::DPT(dmPCA)
        #pseudotime <- dpt$dpt
        
        # Plot DC1 vs DC2 and color the cells by their inferred diffusion pseudotime.
        # We can accesss diffusion pseudotime via dpt$dpt.
        df <- data.frame(
          DC1 = destiny::eigenvectors(dmPCA)[, 1], 
          DC2 = destiny::eigenvectors(dmPCA)[, 2], 
          "DM_Pseudotime" = dpt$dpt
        )
        
        df$cellID <- row.names(dfPCA)
        
        ## For this project reverse pseudotime ##
        if (invertPT){
            PTmax <- max(df$DM_Pseudotime)
            df$DM_Pseudotime <- -1* (df$DM_Pseudotime - PTmax)
            ## Invert DC1, 2, 3
            df$DC1 <- -1* df$DC1
            df$DC2 <- -1* df$DC2
        }
        
        ## For nicer display in this case, invert DC1/DC2
        df$DC1 <- -1* df$DC1
        df$DC2 <- -1* df$DC2
        
        ## Add to table ##
        df$cellID <- row.names(dfPCA)
        
        names(df) <- gsub("^DC", paste0(branches[i], "_DC") ,names(df))
        names(df) <- gsub("^DM_Pseudotime", paste0("DM_Pseudotime_", branches[i]) ,names(df))
        
        dfT <- data.frame(OsC@meta.data[,c("cellID", "clusterName")])
        
        df <- dplyr::full_join(
            df, 
            dfT, 
            by = "cellID"
        )
        
        df[is.na(df)] <- 0
        
        df$clusterName <- NULL
        
        row.names(df) <- df$cellID
        df$cellID <- NULL
        ## Rename columns
        
        ## add here ##
        OsC <- biologicToolsSC::addDf2seuratMetaData(
          obj = OsC, 
          dfAdd = df
        )
        
        ## Create Pseudotime plot ##
        dfTemp <- OsC@meta.data
        dfTemp <- dfTemp[!is.na(dfTemp[,paste0("DM_Pseudotime_", branches[i]) ]),]
        dfTemp <- dfTemp[!(dfTemp[,paste0(branches[i], "_DC1")] == 0 & dfTemp[,paste0(branches[i], "_DC2")] == 0),]
        
        dotsize <- 0.75
        dotcolor <- "darkblue"
        tag <-  paste0(branches[i], "_DC1_DC2_colored_by_DM_Pseudotime")  
        
        if (branches[i] ==  "Branch2sub"){
            selString <- "Branch2"
        } else {
            selString <- branches[i]
        }
        
        
        plotList[[tag]] <- ggplot2::ggplot(dfTemp, ggplot2::aes_string(paste0(branches[i], "_DC1"), paste0(branches[i], "_DC2"), color= paste0("DM_Pseudotime_", branches[i]) )
            )+ ggplot2::geom_point( 
                shape = 16,
                size = as.numeric(dotsize)
            ) + ggplot2::xlab(paste0(branches[i], "_DC1")) + ggplot2::ylab(paste0(branches[i], "_DC2")) + ggplot2::scale_color_gradient(
                "Pseudotime",
                low="#ff6600", 
                high=dotcolor #, 
                #limits=c(0,maxExpr)
            ) + ggplot2::theme_bw(
            ) +  ggplot2::theme(
                axis.text.y   = ggplot2::element_text(size=8),
                axis.text.x   = ggplot2::element_text(size=8),
                axis.title.y  = ggplot2::element_text(size=8),
                axis.title.x  = ggplot2::element_text(size=8),
                axis.line = ggplot2::element_line(colour = "black"),
                panel.border = ggplot2::element_rect(colour = "black", fill=NA, size=1),
                plot.title = ggplot2::element_text(hjust = 0.5, size = 12)
            ) + ggplot2::ggtitle(paste0("DC1, DC2 and DM Pseudotime for ", branches[i])
            )  #+ xlim(minX, maxX) + ylim(minY, maxY)  
        
        
        
                ## Save to file ##
                FNbase <- paste0("Pseudotime_overview", branches[i], VersionPdfExt)
                FN <- paste0(Obio@parameterList$reportFigDir, FNbase)
                FNrel <- paste0("report_figures/", FNbase)
                
               
                pdf(FN)
                print(plotList[[tag]])
                dev.off()
                
                
                
                ## Create R markdown chunk ##
                figLegend <- paste0(
                    '**Figure ', 
                    figureCount, 
                    '**: Figure depicting diffusion map components 1 and 2 with the diffusion map pseudotime highlighted in color. Download a pdf of this figure <a href="',FNrel,'" target="_blank">here</a>. '
                )
                figureCount <- figureCount + 1 
                
                NewChnk <- paste0(
                    "\n### ", gsub("_", " ", tag),
                    "\n```{r ", tag, ", results='asis', echo=F, eval=TRUE, warning=FALSE, fig.cap='",
                    figLegend,"'}\n",
                    "\n",
                    "\n print(plotList[['",tag,"']])",
                    "\n cat(  '\n')",
                    "\n\n\n```\n"   
                )
                
                chnkVec <- c(
                    chnkVec,
                    NewChnk
                )
        
        tag <-  paste0(branches[i], "_DC1_DC2_colored_by_Cluster")   
                
        dfCol <- unique(OsC_dMap@meta.data[,c("clusterName", "clusterColor")])
        
        colVec <- dfCol$clusterColor
        names(colVec) <- dfCol$clusterName
        
        dfTemp <- dfTemp[!(dfTemp[,paste0(branches[i], "_DC1")] == 0 & dfTemp[,paste0(branches[i], "_DC2")] == 0),]
        dfTemp$clusterName <- factor(dfTemp$clusterName)
        
        
        plotList[[tag]] <- ggplot2::ggplot(dfTemp, ggplot2::aes_string(paste0(branches[i], "_DC1"), paste0(branches[i], "_DC2"), color= "clusterName" )
            )+ ggplot2::geom_point( 
                shape = 16,
                size = as.numeric(dotsize)
            ) + ggplot2::xlab(paste0(branches[i], "_DC1")) + ggplot2::ylab(paste0(branches[i], "_DC2"))  + ggplot2::theme_bw(
            ) +  ggplot2::theme(
                axis.text.y   = ggplot2::element_text(size=8),
                axis.text.x   = ggplot2::element_text(size=8),
                axis.title.y  = ggplot2::element_text(size=8),
                axis.title.x  = ggplot2::element_text(size=8),
                axis.line = ggplot2::element_line(colour = "black"),
                panel.border = ggplot2::element_rect(colour = "black", fill=NA, size=1),
                plot.title = ggplot2::element_text(hjust = 0.5, size = 12)
            ) + ggplot2::ggtitle(paste0("DC1, DC2 and DM Pseudotime for ", branches[i])
            ) + ggplot2::scale_color_manual(values = colVec)  
        #+ xlim(minX, maxX) + ylim(minY, maxY)  
        
        
        
                ## Save to file ##
                FNbase <- paste0("Pseudotime_overview", branches[i], VersionPdfExt)
                FN <- paste0(Obio@parameterList$reportFigDir, FNbase)
                FNrel <- paste0("report_figures/", FNbase)
                
               
                pdf(FN)
                print(plotList[[tag]])
                dev.off()
                
                
                
                ## Create R markdown chunk ##
                figLegend <- paste0(
                    '**Figure ', 
                    figureCount, 
                    '**: Figure Diffusionmap DC1 and DC2 components. Download a pdf of this figure <a href="',FNrel,'" target="_blank">here</a>. '
                )
                figureCount <- figureCount + 1 
                
                NewChnk <- paste0(
                    "\n### ", gsub("_", " ", tag),
                    "\n```{r ", tag, ", results='asis', echo=F, eval=TRUE, warning=FALSE, fig.cap='",
                    figLegend,"'}\n",
                    "\n",
                    "\n print(plotList[['",tag,"']])",
                    "\n cat(  '\n')",
                    "\n\n\n```\n"   
                )
                
                chnkVec <- c(
                    chnkVec,
                    NewChnk
                )
}
        
if (length(plotList) > 3){
    tabVar <- ".tabset .tabset-fade .tabset-dropdown"
} else {
    tabVar <- ".tabset .tabset-fade .tabset-pills"
}
```

## Diffusionmap Plots {`r tabVar`} 

```{r pseudotime-plot, echo=T, eval=TRUE, warning=FALSE, results='asis'}
###############################################################################
## Do category enrichment on clusters                                        ##

cat(paste(knitr::knit(text = chnkVec, quiet = T), collapse = '\n'))

## Done doing enrichment on clusters                                         ##
###############################################################################
```



```{r saveobject, eval=TRUE, echo=T, results=F}
### Will save Obio object here, so it can be re-used with different parameters
# save(Obio, 
#      file = paste0(
#          Obio@parameterList$localWorkDir,
#          Obio@parameterList$project_id,
#          ".bioLOGIC.Robj"
#      )
# )
# 
# print("Obio Object saved.")

## OsC saving occurs within the modules already
# save(OsC,
#     file = paste0(
#          Obio@parameterList$localWorkDir,
#          Obio@parameterList$project_id,
#         ".Seurat.Robj"
#      )
# )

print("Obio Object saved.")
save(OsC,
    file = paste0(
         Obio@parameterList$localWorkDir,
         Obio@parameterList$project_id,
        ".Seurat.Robj"
     )
)



```



```{r create_report_params, eval=T, results="asis"}

## Try to retrieve project data from db ##
library(RMySQL)
db.pwd2 <- "zU3ufd9L"
db.user2 <- "reader"
host2 <- "clvd1-db-u-p-17.thecrick.org"
projectParams <- Obio@documentationParams

tryCatch({
    dbDB = DBI::dbConnect(
        drv = RMySQL::MySQL(), 
        user = db.user2, 
        password = db.pwd2, 
        host = host2, 
        dbname = "clarity_shadow"
    )
dfProposal =  DBI::dbGetQuery(dbDB, paste0("SELECT * FROM clarify_asf_proposals WHERE project_name ='",Obio@parameterList$lims.id,"'"))
dbDisconnect(dbDB)
  }, error = function(x) {
    message("Project Database could not be reached or has no entry in Obio@parameterList$lims.id for this analysis.")
   
})

if (exists("dfProposal")){
  if (nrow(dfProposal) == 1){
      if (!is.na(dfProposal[1,"ProjectAlias"]) & dfProposal[1,"ProjectAlias"] != ""){
          projectParams[["title"]] = paste0(dfProposal[1,"ProjectAlias"], " - ", dfProposal[1,"project_name"])
      }
      
      if (!is.na(dfProposal[1,"project_user"]) & dfProposal[1,"project_user"] != ""){
          projectParams[["subtitle"]] = paste0(dfProposal[1,"user_lab"], " Lab - ", dfProposal[1,"project_user"])
          projectParams[["subtitle"]] <- gsub("^ Lab - ", "", projectParams[["subtitle"]])
          
      }
      
      if (!is.na(dfProposal[1,"proposal_text"]) & dfProposal[1,"proposal_text"] != ""){
          projectParams[["abstract"]] = dfProposal[1,"proposal_text"]
         
          
      }
  }
}
   
## Escape all special characters
projectParams <- lapply(
  projectParams, function(x) 
  #gsub("([.|()\\^{}+$*?]|\\[|\\])", "\\\\\1", x)
  gsub("([.|()/\\^{}+$*?]|\\[|\\])", " ", x)
) 

projectParams <- lapply(
  projectParams, function(x) 
  #gsub("([.|()\\^{}+$*?]|\\[|\\])", "\\\\\1", x)
  gsub("\\\n", " ", x)
) 


#projectParams$title <- "Title"
# projectParams$abstract <- "This is the QC section."
#projectParams$subtitle <- "Abstract"

```



## Documentation
```{r documentation, eval=TRUE, echo=T, results=T}

sessionInfo()
```

---
title: "`r projectParams$title`"
subtitle:  "Diffusionmap Module"
author:
    - Bioinformatics: Stefan Boeing^[The Francis Crick Institute, stefan.boeing@crick.ac.uk]
date: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'

abstract: |
    "This module provides a diffusion map pseudotime analysis."


---